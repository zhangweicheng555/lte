<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<!-- 下面我们添加一个meta标签，以便使您的页面更好的在移动平台上展示。 -->
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<title>gis部分的主体部分</title>
<link rel="stylesheet" type="text/css" media="screen" href="../../../css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" media="screen" href="../../../layui/css/layui.css">

	<!-- 处理easyui -->
    <link rel="stylesheet" type="text/css" href="../../../js/easyui/themes/default/easyui.css">
	<link rel="stylesheet" type="text/css" href="../../../js/easyui/themes/icon.css">
	<link rel="stylesheet" href="../../../css/font-awesome/css/font-awesome.css" media="all" />


</head>
<body  class="easyui-layout">
	
	
	    
	    <div data-options="region:'center',border:false" id="center" style="margin-top: -1px;">
	    	<div class="easyui-layout" data-options="fit:true,border:false">
			    <div data-options="region:'center'" style="height: 80%;">
			    	<div class="easyui-panel" title="L3 MESSAGE1" style="height: 100%;" data-options="tools:'#tt'">
								<!--  创建地图的容器 -->
				    			<div id="container" style="width: 100%;height: 100%;"></div> 
					</div>
			    </div>
			    <div data-options="region:'south',title:'LTE Serving+Neighboring Cells',collapsible:true" style="height: 25%;">
						<table class="layui-table" lay-size="sm" style="margin-top: 0px;">
						  <colgroup><col width="150"><col><col><col><col><col><col><col></colgroup>
						  <thead>
						  	<tr><th style="text-align: center;">Type</th><th style="text-align: center;">cellName</th><th style="text-align: center;">SINR</th><th style="text-align: center;">RSRP</th><th style="text-align: center;">CI</th><th style="text-align: center;">TAC</th><th style="text-align: center;">PCI</th><th style="text-align: center;">earfcn</th></tr>
						  </thead>
						  
						  <tbody id="lteLayout">
						  	 <!-- 注意  type  第一个值是PCell  其余的是NCell  -->
						     <!-- <tr><td style="text-align: center;font-weight: bold;">PCell</td><td style="text-align: center;font-weight: bold;">2016-11-29</td><td style="text-align: center;font-weight: bold;">人生</td><td style="text-align: center;font-weight: bold;">贤心</td><td style="text-align: center;font-weight: bold;">2016-11-29</td><td>贤心</td><td style="text-align: center;font-weight: bold;">2016-11-29</td><td style="text-align: center;font-weight: bold;">2016-11-29</td></tr> -->
						  </tbody>
						  
					   </table>			    
			    </div>
	   		</div>
	    </div>
	
	
	    <div data-options="region:'east',border:false" style="width:600px;margin-top: 0px;" >
	    	<div class="easyui-layout" data-options="fit:true,border:false">
			    <div data-options="region:'center',border:false"   style="height:50%;padding: 0px;">
			    
			    	<div class="easyui-panel" title="L3 MESSAGE1" style="height: 100%;" data-options="tools:'#tt1'">
								<!-- 信令 -->
							   <table class="layui-table" lay-size="sm" style="margin-top: 0px;">
								  <colgroup><col width="150"><col><col><col></colgroup>
								  <thead>
								  	<tr><th style="text-align: center;">singaType</th><th style="text-align: center;">messageType</th><th style="text-align: center;">timestamp</th><th style="text-align: center;">channelType</th></tr>
								  </thead>
								  
								  <tbody  id="msgLayout" class="msgTble">
								  	
								  </tbody>
								  
							   </table>	
					</div>
	
			    
			    </div>
			    
			    
			    <div data-options="region:'south',title:'Event',collapsible:true,border:false" style="height:50%;">
			    	<!-- 事件 -->
			    	<table class="layui-table" lay-size="sm" style="margin-top: 0px;">
						  <colgroup><col width="150"><col><col><col><col><col><col><col></colgroup>
						  <thead>
						  	<tr><th style="text-align: center;">mEventType</th><th style="text-align: center;">mEvent</th><th style="text-align: center;">mTimestamp</th></tr>
						  </thead>
						  
						  <tbody  id="eventLayout" class="eventTble">
						  	
						  </tbody>
						  
					   </table>	
			    </div>
	   		</div>
	   		
	    </div>
	
	<!-- 工具条 -->
	<div id="tt">
		<a  class="icon-add" style="margin-right: 8px;" onclick="add();"></a>
		<a  class="icon-edit"  style="margin-right: 8px;" onclick="javascript:alert('edit')"></a>
		<a  class="icon-cut"  style="margin-right: 8px;" onclick="javascript:alert('cut')"></a>
		<a  class="icon-help"  style="margin-right: 8px;" onclick="javascript:alert('help')"></a>
	</div>
	
	<div id="tt1" > 
		   <a  class="icon-search" style="margin-right: 8px;" onclick="msgSearch()"></a>
	</div>
	
</body>
</html>

	<script type="text/javascript" src="../../../js/libs/jquery-2.1.1.min.js" ></script>
	<script type="text/javascript" src="../../../js/easyui/jquery.easyui.min.js"></script>
	
	<script type="text/javascript" src="../../../layui/layui.js" ></script>
	<script type="text/javascript" src="../../../js/jq.js"></script>
	<script type="text/javascript" src="../../../js/common.js" charset="UTF-8"></script>

    <!-- 百度地图api -->
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=3.0&ak=vEgRtpbR6hgHTNtN0HiHhTPLDxaCl3YE"></script>

	<script type="text/javascript">
	
	var pointEntity;//轨迹回放的时候的记录上一个点
	var myP1 ;    //起点
	var myP2 ;    //终点
	
	var map;   //百度地图对象
	var car;   //汽车图标
	var centerPoint;
	var timer;     //定时器
	var index = 0; //记录播放到第几个point

	//添加按钮测试使用
	function  add(){
		map.addOverlay(car);
		if(index==0){
			 $("#msgLayout").empty();
			 $("#eventLayout").empty();
		}
		var point = points[index];
		console.info('+++++++++++++++++++++++++++++++++++++++');
		console.info(index);
		if(index > 0) {
			map.addOverlay(new BMap.Polyline([points[index - 1], point], {strokeColor: "red", strokeWeight: 1, strokeOpacity: 1}));
		}
		car.setPosition(point);
		index++;
		map.panTo(point);
		if(index < points.length) {
			timer = window.setTimeout("add(" + index + ")", 500);
		} else {//  便利结束之后  立马 移除所有的覆盖物  然后重新绘制海量的数据点
			parent.layer.msg("回放结束");
			map.clearOverlays();  //移除所有的覆盖物    
			//绘制海量点
		    addPointsOverlay("blue",points);
		    $("#msgLayout").empty();
			$("#eventLayout").empty();
			//处理信令
			for(var t=0;t<msgArrayData.length;t++){
				var msgData=msgArrayData[t];
				var msgDataArray=msgData.split('~');
				var msgHtml=msgDataArray[1];
				$("#msgLayout").prepend(msgHtml);
			}
			//处理事件
			for(var w=0;w<eventArrayData.length;w++){
				var msgData=eventArrayData[w];
				var msgDataArray=msgData.split('~');
				var msgHtml=msgDataArray[1];
				$("#eventLayout").prepend(msgHtml);
			}
		}
		
		var lat=point.lat;
		var lng=point.lng;
		
		//处理信令
		for(var t=0;t<msgArrayData.length;t++){
			var msgData=msgArrayData[t];
			var msgDataArray=msgData.split('~');
			var one=msgDataArray[0];
			var msgHtml=msgDataArray[1];
			var latlng=one.split("_");
			if(lng==latlng[0] && lat==latlng[1]){
				 $("#msgLayout").prepend(msgHtml);
			}
		}
		//处理事件
		for(var w=0;w<eventArrayData.length;w++){
			var msgData=eventArrayData[w];
			var msgDataArray=msgData.split('~');
			var one=msgDataArray[0];
			var msgHtml=msgDataArray[1];
			var latlng=one.split("_");
			if(lng==latlng[0] && lat==latlng[1]){
				 $("#eventLayout").prepend(msgHtml);
			}
		} 
		//左下角模块
		 queryButtonDta(lng,lat);
		
	}
	
	
	
	//画折线
	function addPolyline(pointOne,pointTwo){
		var polyline = new BMap.Polyline([pointOne,pointTwo], {strokeColor:"blue", strokeWeight:2, strokeOpacity:0.5});   //创建折线
		map.addOverlay(polyline);          //增加折线
	}
	


	
	//信令搜索功能
	function msgSearch(){
		//parent.layer.msg("你点击了信令的搜索");
		parent.layer.open({
			  content: 'test'
			  ,offset: 't'
			  ,anim: 3
			  ,title:'信令搜索'
			  ,shade:0
			  ,area: ['400px', '180px']
			  ,btn: ['搜索', '按钮二', '按钮三']
			  ,yes: function(index, layero){
			    //按钮【按钮一】的回调
			  }
			  ,btn2: function(index, layero){
			    //按钮【按钮二】的回调
			    //return false 开启该代码可禁止点击该按钮关闭
			  }
			  ,btn3: function(index, layero){
			    //按钮【按钮三】的回调
			    //return false 开启该代码可禁止点击该按钮关闭
			  }
			  ,cancel: function(){ 
			    //右上角关闭回调
			    //return false 开启该代码可禁止点击该按钮关闭
			  }
			});
	};
	
	//点击查看信令信息
	 function selectCustomerDb(obj){//这个obj 是每条信令得id  selectCustomerDb
		 $.ajax({
			   type: "POST"
			   ,url: "/es/queryList"
			   ,dataType: "json"
			   ,contentType:"application/json;charset=utf-8"
			   ,data: '{"type":"logmessage","index":"logmessage","limit":1,"termMap":{"id.keyword":"'+obj+'"},"revelFields":["message","longitude","latitude"],"revelPk":"false"}'
			   ,success: function(msg){
				   common.closeLoadingDialog();
				  if(msg !=null && msg.length>0){
					  for(var i=0;i<msg.length;i++){
						  var model=msg[i];
						   parent.layer.open({
						        type: 1
						        ,title: false //不显示标题栏
						        ,shadeClose:true
						        ,time:50000
						        ,closeBtn: 0
						        ,area: ['800px', '300px']
						        ,shade: 0.8
						        ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
						        ,moveType: 1 //拖拽模式，0或者1
						        ,content: '<html><div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-weight: 300;"><pre>'+model.message+'</pre></div></html>' //这里content是一个普通的String
						      }); 
						  
					  }
				  }
			   }
			});
	}
	
	//单击轨迹问题
	 function selectCustomerSingle(obj){//单挑信令得id  selectCustomerSingle
		    common.showLoadingDialog();
	        $.ajax({
				   type: "POST"
				   ,url: "/es/queryList"
				   ,dataType: "json"
				   ,contentType:"application/json;charset=utf-8"
				   ,data: '{"type":"logmessage","index":"logmessage","limit":1,"termMap":{"id.keyword":"'+obj+'"},"revelFields":["longitude","latitude"],"revelPk":"false"}'
				   ,success: function(msg){
					   common.closeLoadingDialog();
					  if(msg !=null && msg.length>0){
						  for(var i=0;i<msg.length;i++){
							  var model=msg[i];
							  //地图渲染点 并且移动--这个地图后期是拉线得问题
							  var points1 = [];
							  var point=new BMap.Point(model.longitude, model.latitude);
							   map.panTo(point); //地图移动到该点位置
							   
							       var options = {
							            color: 'red'
							        }
							       points1.push(point);
							        var pointCollection = new BMap.PointCollection(points1, options);  // 初始化PointCollection
							        pointCollection.addEventListener('click', function (e) {
							        	//加载此点对应的的前后十分钟的数据
							        	//queryMsgEventData(e.point.lng,e.point.lat);
							        });
							        map.addOverlay(pointCollection);  // 添加Overlay
							        //加载左下角得数据
							        queryButtonDta(model.longitude, model.latitude);
						  }
					  }
				   }
				});
	 }
	
	
	//将点添加到地图上
	function addPointMap(color,point){
		var pointsArrayModel=[];
		var options = {
	            color: color
	        }
		pointsArrayModel.push(point);
	        var pointCollection = new BMap.PointCollection(pointsArrayModel, options);  // 初始化PointCollection
	        pointCollection.addEventListener('click', function (e) {
	        	//加载此点对应的的前后十分钟的数据
	        	//queryMsgEventData(e.point.lng,e.point.lat);
	        });
	        map.addOverlay(pointCollection);  // 添加Overlay
	}
	
	
	var currData;
	var checkArray=new Array();
	var map;
	var loadData=true;
	
	 var diatinctArray = new Array();//起到去重 和寻找此经纬度对应的时间的作用
	 
	 
	 var msgArrayData=[];  //全部信令的信息
	 var eventArrayData=[];  //全部事件的信息
	 var latlonArrayData=[];  //全部经纬度的信息  diatinctArray.push(obj.longitude+"_"+obj.latitude+"-"+obj.testTime);
	
	 
	 var common;
	 var layer;
	 var mainLogId;
	 var points = [];  // 添加海量点数据  里面是一下 new map point对象
	layui.use([ 'layer' ,'table','jquery','common'], function() {
	   layer = layui.layer;
	  var $=layui.$;
	  common = layui.common;
	  var table = layui.table;
	  
	  //室外测试id
	  mainLogId=getUrlParam("id");
	
	  //展示加载层
	  common.showLoadingDialog();
	   /***地图部分开始*/
	  
		//创建地图实例
		map = new BMap.Map("container",{enableMapClick: false});  //屏蔽地图的点击 出现框的问题
		//地图的初始化，必须具备这个初始化操作之后 才能进行后续的操作   中心点和展示级别
		 map.centerAndZoom("上海",50);      // 初始化地图,用城市名设置地图中心点
		 //map.centerAndZoom(new BMap.Point(121.493, 31.250), 11);
		 //开启鼠标缩放
		 map.enableScrollWheelZoom(true);
		 map.enableAutoResize();
		 //设置地图默认的鼠标指针样式
		 map.setDefaultCursor("url('bird.cur')");  
		 map.addControl(new BMap.MapTypeControl({
				mapTypes:[
		            BMAP_NORMAL_MAP,
		            BMAP_HYBRID_MAP
		 ]}));
		 //地图加载完毕 需要做的事情
		 map.addEventListener("tilesloaded",function(){//注意 是地图 第一次加载完成得时候 做的操作 
			 if(loadData){
				 queryMainLog();
			 }
		 });
		
		 /***地图部分结束  */
		
});

	
	
    //根据经纬度返回在这个数组里面的时间
    function queryTimeFromArray(longitude,latitude,arr) {//数组里面存储的是  lon_lat-testTime
	    var i = arr.length;
	    while(i--) {
	    	var obj=arr[i];
	    	if(obj){
	    		var array=obj.split("-");
		    	if(array !=null && array.length==2){
		    		var latlng=array[0].split("_");
		    		if(latlng !=null && latlng.length==2){
				        if(latlng[0] == longitude && latlng[1] == latitude ) {
				            return array[1];
				        }
		    		}
		    	}
	    	}
	    }
	    return -1;
	}
    
	

	 /***平台操作部分*/
	function queryMainLog(){
		 parent.layer.msg('正在加载数据。。。');
	           //判断是不是支持还两点得绘制
				if (document.createElement('canvas').getContext) {  // 判断当前浏览器是否支持绘制海量点
			        //加载日志得数据
					$.ajax({
						   type: "POST"
						   ,url: "/es/buss/queryMainLog"
						   ,dataType: "json"
						   ,contentType:"application/json;charset=utf-8"
						   ,data: '{"type":"logmain","index":"logmain","pid":"'+mainLogId+'","termMap":{"pid.keyword":"'+mainLogId+'"},"limit":1000,"sortMap":{"testTime":"ASC"},"revelFields":["longitude","latitude","testTime","id","cellName","sinr","rsrp","cI","tAC","pci","earfcn","mSignaBean","mSignaEventBean","doorDataInfoBeans"],"revelPk":"false"}'
						   ,success: function(msg){
							   loadData=false;//禁止数据得变化
							   common.closeLoadingDialog();
							  if(msg && msg.length>0){
								  for(var i=0;i<msg.length;i++){
									  var obj=msg[i];
									  if(i==0){//移动地图到第一个点得位置
										  map.panTo(new BMap.Point(obj.longitude, obj.latitude)); //地图移动到该点位置
									  }
									  var index=contains(obj.longitude,obj.latitude,obj.testTime,diatinctArray);
									  if(index == -1){//不在数组中
										  points.push(new BMap.Point(obj.longitude, obj.latitude));
										  if(obj.testTime){
											  diatinctArray.push(obj.longitude+"_"+obj.latitude+"-"+obj.testTime);
										  }
									  }
									  if(i==(msg.length-1)){
										  //最后一个点  加载主左下角信息
										  $("#lteLayout").empty();
 				 						  var lteLayoutLhtml=loadLteHtml(obj);
										  $("#lteLayout").append(lteLayoutLhtml);
									  }
									  //加载信令
									  loadMsgHtml(obj,msgArrayData);
									  //加载事件
									  loadEventHtml(obj,eventArrayData);
								   }
								      //绘制海量点
								      addPointsOverlay("blue",points);
								       //数据存储
										var latlonArrayData=diatinctArray;  //全部经纬度的信息   diatinctArray.push(obj.longitude+"_"+obj.latitude+"-"+obj.testTime);
										
										//绘制回放路线
										//通过DrivingRoute获取一条路线的point
										var driving = new BMap.DrivingRoute(map);
										driving.search(points[0], points[points.length-1]);
										driving.setSearchCompleteCallback(function() {
										car = new BMap.Marker(points[0]);
										});
							  }else{
								  parent.layer.msg("查询得数据不存在");
							  } 
						   }
						});	
			    } else {
			        parent.layer.msg('请在chrome、safari、IE8+以上浏览器查看本示例');
			    };	
	 }
	 
 //添加海量点
 function addPointsOverlay(color,points){
	        var options = {
	            color: 'blue'
	        }
	        var pointCollection = new BMap.PointCollection(points, options);  // 初始化PointCollection
	        pointCollection.addEventListener('click', function (e) {
	        	//加载此点对应的的前后十分钟的数据
	        	//queryMsgEventData(e.point.lng,e.point.lat);
	        });
	        map.addOverlay(pointCollection);  // 添加Overlay
 }

//根据经纬度加载 左下角最后得数据
function queryButtonDta(longitudeModel,latitudeModel){
	 $.ajax({
		   type: "POST"
		   ,url: "/es/queryList"
		   ,dataType: "json"
		   ,contentType:"application/json;charset=utf-8"
		   ,data: '{"type":"logmain","index":"logmain","limit":1,"termMap":{"longitude":"'+longitudeModel+'","latitude":"'+latitudeModel+'"},"sortMap":{"testTime":"ASC"},"revelFields":["id","latitude","cellName","sinr","rsrp","cI","tAC","pci","earfcn","doorDataInfoBeans","testTime","mSignaEventBean","mSignaBean"]}'
		   ,success: function(msg){
			  if(msg && msg.length>0){
				  var lteLayoutLhtml="";
				  for(var i=0;i<msg.length;i++){
					  var obj=msg[i];
					  //根据obj加载左下角的日志信息
					  lteLayoutLhtml= loadLteHtml(obj);
				   }
				  $("#lteLayout").empty();
				  $("#lteLayout").append(lteLayoutLhtml);

			  }else{
				  parent.layer.msg("查询得数据不存在");
			  } 
		   }
		});	
}


//传入主log信息 返回左下角的表格tr，以及邻区信息
function loadLteHtml(obj){
	var lteLayoutLhtml="";
	if(obj){
   	  lteLayoutLhtml= '<tr><td style="text-align: center;font-weight: bold;">PCell</td><td style="text-align: center;font-weight: bold;">'+obj.cellName+'</td><td style="text-align: center;font-weight: bold;">'+obj.sinr+'</td><td style="text-align: center;font-weight: bold;">'+obj.rsrp+'</td><td style="text-align: center;font-weight: bold;">'+obj.cI+'</td><td style="text-align: center;font-weight: bold;">'+obj.tAC+'</td><td style="text-align: center;font-weight: bold;">'+obj.pci+'</td><td style="text-align: center;font-weight: bold;">'+obj.earfcn+'</td></tr>'
		  //加载邻区信息
		  var doorDataInfoBeans=obj.doorDataInfoBeans;
		   if(doorDataInfoBeans){
			  var mLteNeighborhoodInfos=doorDataInfoBeans.mLteNeighborhoodInfos;
			  if(mLteNeighborhoodInfos && mLteNeighborhoodInfos.length>0){
				  for(var j=0;j<mLteNeighborhoodInfos.length;j++){
					  var model=mLteNeighborhoodInfos[j];
			          lteLayoutLhtml= lteLayoutLhtml+'<tr><td style="text-align: center;">NCell</td><td style="text-align: center;"> </td><td style="text-align: center;">'+doorDataInfoBeans.sinr+'</td><td style="text-align: center;">'+doorDataInfoBeans.rsrp+'</td><td style="text-align: center;">'+model.mLteNeighborhoodCI+'</td><td style="text-align: center;">'+model.mLteNeighborhoodTAC+'</td><td style="text-align: center;">'+model.mLteNeighborhoodPCI+'</td><td style="text-align: center;">'+model.mLteNeighborhoodEarfcn+'</td></tr>'
				  }
			  }
		  }
	}
	return lteLayoutLhtml;
}





//传入主log信息 处理信令模块的数据
function loadMsgHtml(obj,msgArrayData){
	if(obj){
	   var mSignaBean=obj.mSignaBean;
	   if(mSignaBean && mSignaBean.length>0){
		   for(var w=0;w<mSignaBean.length;w++){
			   var objEvent=mSignaBean[w];
			   var upFlag=objEvent.mSingaType;
			   if('ul'==upFlag){
				   upFlag='<i class="fa fa-long-arrow-up" aria-hidden="true"  style="color: blue;"></i>';
			   }
			   else if('dl'==upFlag){
				   upFlag='<i class="fa fa-long-arrow-down" aria-hidden="true" style="color: red;"></i>';
			   }else{
				   upFlag='<i class="fa fa-arrows" aria-hidden="true"></i>';
			   }
			   var htmlModel='<tr   ><td onclick="selectCustomerDb(\''+objEvent.mMeaasge+'\');"  title="点我查看信令明细"  style="text-align: center;">'+upFlag+'</td><td onclick="selectCustomerSingle(\''+objEvent.mMeaasge+'\');"  style="text-align: center;">'+objEvent.mMessageType+'</td><td  onclick="selectCustomerSingle(\''+objEvent.mMeaasge+'\');"  style="text-align: center;">'+objEvent.mTimestamp+'</td><td  onclick="selectCustomerSingle(\''+objEvent.mMeaasge+'\');"  style="text-align: center;">'+objEvent.mChannelType+'</td></tr> ';
			   msgArrayData.push(obj.longitude+"_"+obj.latitude+"~"+htmlModel);
			   $("#msgLayout").append(htmlModel);
		   }
	   }
	}
}





//传入主log信息 处理事件模块的数据
function loadEventHtml(obj,eventArrayData){
	if(obj){
		 var mSignaEventBean=obj.mSignaEventBean;
		   if(mSignaEventBean && mSignaEventBean.length>0){
			   for(var w=0;w<mSignaEventBean.length;w++){
				   var objEvent=mSignaEventBean[w];
				   var htmlModel='<tr  ondblclick="selectCustomerDb(\''+obj.id+'\');" lang='+obj.id+'><td style="text-align: center;">'+objEvent.mEventType+'</td><td style="text-align: center;">'+objEvent.mEvent+'</td><td style="text-align: center;">'+objEvent.mTimestamp+'</td></tr> ';
				   eventArrayData.push(obj.longitude+"_"+obj.latitude+"~"+htmlModel);
				   $("#eventLayout").append(htmlModel);
			   }
		   }
	}
}



 
 
//扩展经纬度的循环判断的原则
function contains(longitude,latitude,testTime,arr) {//数组里面存储的是  lon_lat-testTime
   var i = arr.length;
   while(i--) {
   	var obj=arr[i];
   	if(obj){
   		var array=obj.split("-");
	    	if(array !=null && array.length==2){
	    		var latlng=array[0].split("_");
	    		if(latlng !=null && latlng.length==2){
			        if(latlng[0] == longitude && latlng[1] == latitude ) {
			           if(testTime){
			        	   arr[i]=longitude+"_"+latitude+"-"+testTime;
			        	} 
			            return i;
			        }
	    		}
	    	}
   	}
   }
   return -1;
}

	
</script>



